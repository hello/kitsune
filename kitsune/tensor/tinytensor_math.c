#include "tinytensor_math.h"
#include "kit_assert.h"

//not including header because of macro definition conflicts
extern uint32_t FixedPointExp2Q10(const int16_t x);


__attribute__((section(".data")))
const static int16_t k_tanh_slopes[1024] = {32767,32766,32764,32761,32757,32752,32746,32739,32731,32722,32712,32701,32689,32677,32663,32648,32632,32615,32597,32578,32558,32537,32516,32493,32469,32444,32419,32392,32365,32336,32307,32276,32245,32213,32179,32145,32110,32074,32037,32000,31961,31921,31881,31839,31797,31754,31710,31665,31619,31572,31525,31476,31427,31377,31326,31274,31222,31168,31114,31059,31003,30947,30889,30831,30772,30713,30652,30591,30529,30466,30403,30339,30274,30208,30142,30075,30007,29939,29870,29800,29730,29659,29587,29514,29442,29368,29294,29219,29143,29067,28991,28914,28836,28758,28679,28599,28519,28439,28358,28276,28194,28112,28029,27945,27861,27777,27692,27606,27521,27434,27348,27261,27173,27085,26997,26908,26819,26730,26640,26550,26459,26368,26277,26185,26094,26001,25909,25816,25723,25630,25536,25442,25348,25254,25159,25065,24970,24874,24779,24683,24587,24491,24395,24298,24202,24105,24008,23911,23814,23717,23619,23522,23424,23326,23228,23130,23032,22934,22836,22738,22640,22541,22443,22344,22246,22147,22049,21950,21852,21753,21655,21556,21458,21359,21261,21162,21064,20966,20867,20769,20671,20573,20475,20377,20279,20181,20084,19986,19889,19791,19694,19597,19500,19403,19306,19210,19113,19017,18921,18825,18729,18633,18538,18442,18347,18252,18157,18063,17968,17874,17780,17686,17592,17499,17406,17313,17220,17128,17035,16943,16851,16760,16668,16577,16486,16395,16305,16215,16125,16035,15946,15857,15768,15679,15591,15503,15415,15328,15240,15153,15067,14980,14894,14809,14723,14638,14553,14468,14384,14300,14216,14133,14050,13967,13884,13802,13720,13639,13558,13477,13396,13316,13236,13156,13077,12998,12919,12840,12762,12685,12607,12530,12453,12377,12301,12225,12150,12074,12000,11925,11851,11777,11704,11631,11558,11485,11413,11341,11270,11199,11128,11057,10987,10917,10848,10779,10710,10641,10573,10505,10438,10371,10304,10238,10171,10106,10040,9975,9910,9846,9781,9718,9654,9591,9528,9465,9403,9341,9280,9219,9158,9097,9037,8977,8917,8858,8799,8741,8682,8624,8567,8509,8452,8395,8339,8283,8227,8172,8116,8062,8007,7953,7899,7845,7792,7739,7686,7634,7582,7530,7479,7427,7377,7326,7276,7226,7176,7127,7077,7029,6980,6932,6884,6836,6789,6742,6695,6649,6602,6556,6511,6465,6420,6375,6331,6286,6242,6199,6155,6112,6069,6026,5984,5942,5900,5858,5817,5776,5735,5695,5654,5614,5574,5535,5496,5456,5418,5379,5341,5303,5265,5227,5190,5153,5116,5080,5043,5007,4971,4936,4900,4865,4830,4795,4761,4726,4692,4659,4625,4592,4558,4526,4493,4460,4428,4396,4364,4332,4301,4270,4239,4208,4177,4147,4117,4087,4057,4028,3998,3969,3940,3911,3883,3854,3826,3798,3770,3743,3715,3688,3661,3634,3607,3581,3555,3528,3502,3477,3451,3426,3400,3375,3350,3326,3301,3277,3253,3229,3205,3181,3158,3134,3111,3088,3065,3042,3020,2997,2975,2953,2931,2909,2888,2866,2845,2824,2803,2782,2761,2741,2720,2700,2680,2660,2640,2620,2601,2581,2562,2543,2524,2505,2486,2467,2449,2431,2412,2394,2376,2359,2341,2323,2306,2289,2271,2254,2237,2221,2204,2187,2171,2155,2138,2122,2106,2090,2075,2059,2043,2028,2013,1998,1983,1968,1953,1938,1923,1909,1894,1880,1866,1852,1838,1824,1810,1796,1783,1769,1756,1743,1729,1716,1703,1690,1678,1665,1652,1640,1627,1615,1603,1590,1578,1566,1554,1543,1531,1519,1508,1496,1485,1474,1462,1451,1440,1429,1418,1408,1397,1386,1376,1365,1355,1344,1334,1324,1314,1304,1294,1284,1274,1264,1255,1245,1236,1226,1217,1208,1198,1189,1180,1171,1162,1153,1144,1136,1127,1118,1110,1101,1093,1085,1076,1068,1060,1052,1044,1036,1028,1020,1012,1004,997,989,981,974,966,959,952,944,937,930,923,916,909,902,895,888,881,874,868,861,854,848,841,835,828,822,816,809,803,797,791,785,779,773,767,761,755,749,743,738,732,726,721,715,710,704,699,693,688,683,678,672,667,662,657,652,647,642,637,632,627,622,617,613,608,603,599,594,589,585,580,576,571,567,563,558,554,550,545,541,537,533,529,525,521,517,513,509,505,501,497,493,489,485,482,478,474,471,467,463,460,456,453,449,446,442,439,435,432,429,425,422,419,416,412,409,406,403,400,397,394,391,388,385,382,379,376,373,370,367,364,361,359,356,353,350,348,345,342,340,337,334,332,329,327,324,322,319,317,314,312,309,307,304,302,300,297,295,293,291,288,286,284,282,279,277,275,273,271,269,267,265,263,261,259,257,255,253,251,249,247,245,243,241,239,237,235,234,232,230,228,226,225,223,221,219,218,216,214,213,211,209,208,206,205,203,201,200,198,197,195,194,192,191,189,188,186,185,183,182,181,179,178,176,175,174,172,171,170,168,167,166,164,163,162,161,159,158,157,156,154,153,152,151,150,148,147,146,145,144,143,142,141,139,138,137,136,135,134,133,132,131,130,129,128,127,126,125,124,123,122,121,120,119,118,117,117,116,115,114,113,112,111,110,109,109,108,107,106,105,104,104,103,102,101,100,100,99,98,97,97,96,95,94,94,93,92,91,91,90,89,89,88,87,86,86,85,84,84,83,83,82,81,81,80,79,79,78,77,77,76,76,75,75,74,73,73,72,72,71,71,70,69,69,68,68,67,67,66,66,65,65,64,64,63,63,62,62,61,61,60,60,59,59,58,58,57,57,57,56,56,55,55,54,54,54,53,53,52,52,51,51,51,50,50,49,49,49,48,48,48,47,47,46,46,46,45,45,45,44,44,44};

__attribute__((section(".data")))
const static int16_t k_tanh_yvals[1024] = {0,127,255,383,511,639,767,895,1023,1151,1279,1407,1534,1662,1790,1917,2045,2172,2300,2427,2554,2681,2809,2936,3063,3189,3316,3443,3569,3696,3822,3948,4074,4200,4326,4452,4577,4703,4828,4953,5078,5203,5328,5452,5577,5701,5825,5949,6072,6196,6319,6442,6565,6688,6811,6933,7055,7177,7299,7421,7542,7663,7784,7905,8025,8145,8265,8385,8504,8624,8743,8861,8980,9098,9216,9334,9451,9569,9686,9802,9919,10035,10151,10266,10382,10497,10611,10726,10840,10954,11067,11180,11293,11406,11518,11630,11742,11854,11965,12075,12186,12296,12406,12515,12624,12733,12842,12950,13058,13165,13273,13379,13486,13592,13698,13803,13908,14013,14118,14222,14325,14429,14532,14634,14737,14839,14940,15041,15142,15243,15343,15443,15542,15641,15740,15838,15936,16033,16130,16227,16324,16420,16515,16611,16706,16800,16894,16988,17082,17175,17267,17359,17451,17543,17634,17725,17815,17905,17995,18084,18173,18261,18349,18437,18524,18611,18697,18784,18869,18955,19040,19124,19208,19292,19376,19459,19541,19624,19706,19787,19868,19949,20029,20109,20189,20268,20347,20425,20504,20581,20659,20736,20812,20888,20964,21039,21114,21189,21263,21337,21411,21484,21557,21629,21701,21773,21844,21915,21986,22056,22126,22195,22264,22333,22401,22469,22537,22604,22671,22738,22804,22870,22935,23000,23065,23129,23194,23257,23321,23384,23446,23508,23570,23632,23693,23754,23815,23875,23935,23994,24054,24112,24171,24229,24287,24344,24402,24459,24515,24571,24627,24683,24738,24793,24847,24902,24955,25009,25062,25115,25168,25220,25272,25324,25375,25426,25477,25528,25578,25628,25677,25726,25775,25824,25872,25920,25968,26016,26063,26110,26156,26203,26249,26294,26340,26385,26430,26474,26519,26563,26606,26650,26693,26736,26779,26821,26863,26905,26947,26988,27029,27070,27110,27150,27190,27230,27270,27309,27348,27387,27425,27463,27501,27539,27576,27614,27651,27687,27724,27760,27796,27832,27867,27903,27938,27973,28007,28042,28076,28110,28143,28177,28210,28243,28276,28308,28341,28373,28405,28437,28468,28499,28530,28561,28592,28622,28653,28683,28712,28742,28771,28801,28830,28858,28887,28916,28944,28972,29000,29027,29055,29082,29109,29136,29163,29189,29216,29242,29268,29293,29319,29344,29370,29395,29420,29444,29469,29493,29518,29542,29566,29589,29613,29636,29659,29682,29705,29728,29751,29773,29795,29817,29839,29861,29883,29904,29925,29947,29968,29989,30009,30030,30050,30071,30091,30111,30130,30150,30170,30189,30208,30228,30247,30265,30284,30303,30321,30340,30358,30376,30394,30412,30429,30447,30464,30482,30499,30516,30533,30549,30566,30583,30599,30615,30632,30648,30664,30680,30695,30711,30726,30742,30757,30772,30787,30802,30817,30832,30846,30861,30875,30890,30904,30918,30932,30946,30960,30973,30987,31000,31014,31027,31040,31053,31066,31079,31092,31105,31117,31130,31142,31155,31167,31179,31191,31203,31215,31227,31238,31250,31262,31273,31284,31296,31307,31318,31329,31340,31351,31362,31372,31383,31394,31404,31414,31425,31435,31445,31455,31465,31475,31485,31495,31505,31514,31524,31533,31543,31552,31561,31571,31580,31589,31598,31607,31616,31624,31633,31642,31650,31659,31667,31676,31684,31693,31701,31709,31717,31725,31733,31741,31749,31757,31764,31772,31780,31787,31795,31802,31810,31817,31824,31832,31839,31846,31853,31860,31867,31874,31881,31887,31894,31901,31908,31914,31921,31927,31934,31940,31946,31953,31959,31965,31971,31978,31984,31990,31996,32002,32007,32013,32019,32025,32031,32036,32042,32047,32053,32059,32064,32069,32075,32080,32085,32091,32096,32101,32106,32111,32116,32121,32126,32131,32136,32141,32146,32151,32155,32160,32165,32169,32174,32179,32183,32188,32192,32197,32201,32205,32210,32214,32218,32223,32227,32231,32235,32239,32243,32247,32251,32255,32259,32263,32267,32271,32275,32279,32282,32286,32290,32293,32297,32301,32304,32308,32312,32315,32319,32322,32325,32329,32332,32336,32339,32342,32346,32349,32352,32355,32358,32362,32365,32368,32371,32374,32377,32380,32383,32386,32389,32392,32395,32398,32401,32403,32406,32409,32412,32415,32417,32420,32423,32425,32428,32431,32433,32436,32438,32441,32444,32446,32449,32451,32453,32456,32458,32461,32463,32465,32468,32470,32472,32475,32477,32479,32481,32484,32486,32488,32490,32492,32494,32497,32499,32501,32503,32505,32507,32509,32511,32513,32515,32517,32519,32521,32523,32525,32526,32528,32530,32532,32534,32536,32537,32539,32541,32543,32544,32546,32548,32550,32551,32553,32555,32556,32558,32560,32561,32563,32564,32566,32568,32569,32571,32572,32574,32575,32577,32578,32580,32581,32583,32584,32585,32587,32588,32590,32591,32592,32594,32595,32596,32598,32599,32600,32602,32603,32604,32605,32607,32608,32609,32610,32612,32613,32614,32615,32616,32618,32619,32620,32621,32622,32623,32624,32626,32627,32628,32629,32630,32631,32632,32633,32634,32635,32636,32637,32638,32639,32640,32641,32642,32643,32644,32645,32646,32647,32648,32649,32650,32651,32652,32653,32653,32654,32655,32656,32657,32658,32659,32659,32660,32661,32662,32663,32664,32664,32665,32666,32667,32668,32668,32669,32670,32671,32671,32672,32673,32674,32674,32675,32676,32677,32677,32678,32679,32679,32680,32681,32681,32682,32683,32683,32684,32685,32685,32686,32687,32687,32688,32688,32689,32690,32690,32691,32691,32692,32693,32693,32694,32694,32695,32695,32696,32697,32697,32698,32698,32699,32699,32700,32700,32701,32701,32702,32702,32703,32703,32704,32704,32705,32705,32706,32706,32707,32707,32708,32708,32709,32709,32710,32710,32711,32711,32711,32712,32712,32713,32713,32714,32714,32714,32715,32715,32716,32716,32716,32717,32717,32718,32718,32718,32719,32719,32720,32720,32720,32721,32721,32721,32722,32722,32722,32723,32723,32723,32724,32724,32724,32725,32725,32725,32726,32726,32726,32727,32727,32727,32728,32728,32728,32729,32729,32729,32730,32730,32730,32730,32731,32731,32731,32732,32732,32732,32732,32733,32733,32733,32733,32734,32734,32734,32735,32735,32735,32735,32736,32736,32736,32736,32737,32737,32737,32737,32737,32738,32738,32738,32738,32739,32739,32739,32739,32740,32740,32740,32740,32740,32741,32741,32741,32741,32741,32742,32742,32742,32742,32742,32743,32743,32743,32743,32743,32744,32744,32744,32744,32744,32744,32745,32745,32745,32745,32745};


const static int32_t k_exp_slopes[1024] = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,9,9,9,9,9,9,9,10,10,10,10,10,10,11,11,11,11,11,11,12,12,12,12,12,13,13,13,13,13,14,14,14,14,15,15,15,15,16,16,16,16,17,17,17,17,18,18,18,19,19,19,20,20,20,20,21,21,22,22,22,23,23,23,24,24,24,25,25,26,26,26,27,27,28,28,29,29,30,30,31,31,32,32,33,33,34,34,35,35,36,36,37,38,38,39,39,40,41,41,42,43,43,44,45,45,46,47,48,48,49,50,51,51,52,53,54,55,56,57,57,58,59,60,61,62,63,64,65,66,67,68,69,71,72,73,74,75,76,78,79,80,81,83,84,85,87,88,89,91,92,94,95,97,98,100,101,103,104,106,108,110,111,113,115,117,118,120,122,124,126,128,130,132,134,136,139,141,143,145,148,150,152,155,157,160,162,165,167,170,173,175,178,181,184,187,190,193,196,199,202,205,208,212,215,218,222,225,229,232,236,240,244,247,251,255,259,263,268,272,276,280,285,289,294,299,303,308,313,318,323,328,333,338,344,349,355,360,366,372,378,383,390,396,402,408,415,421,428,435,441,448,455,463,470,477,485,493,500,508,516,524,533,541,550,558,567,576,585,594,604,613,623,633,643,653,663,673,684,695,706,717,728,740,751,763,775,787,800,812,825,838,851,865,878,892,906,921,935,950,965,980,995,1011,1027,1043,1060,1076,1093,1111,1128,1146,1164,1182,1201,1220,1239,1259,1278,1298,1319,1340,1361,1382,1404,1426,1449,1471,1495,1518,1542,1566,1591,1616,1642,1667,1694,1720,1747,1775,1803,1831,1860,1890,1919,1950,1980,2011,2043,2075,2108,2141,2175,2209,2244,2279,2315,2352,2389,2426,2465,2503,2543,2583,2624,2665,2707,2749,2793,2837,2881,2927,2973,3020,3067,3116,3165,3215,3265,3317,3369,3422,3476,3531,3586,3643,3700,3758,3817,3878,3939,4001,4064,4128,4193,4259,4326,4394,4463,4533,4605,4677,4751,4826,4902,4979,5057,5137,5218,5300,5384,5468,5555,5642,5731,5821,5913,6006,6101,6197,6294,6393,6494,6596,6700,6806,6913,7022,7132,7245,7359,7475,7592,7712,7833,7957,8082,8209,8339,8470,8603,8739,8876,9016,9158,9302,9449,9598,9749,9902,10058,10217,10378,10541,10707,10876,11047,11221,11398,11577,11760,11945,12133,12324,12518,12715,12915,13119,13325,13535,13748,13965,14185,14408,14635,14866,15100,15338,15579,15824,16074,16327,16584,16845,17110,17380,17653,17931,18214,18501,18792,19088,19389,19694,20004,20319,20639,20964,21294,21630,21970,22316,22668,23025,23387,23755,24130,24510,24896,25288,25686,26090,26501,26919,27342,27773,28210,28655,29106,29564,30030,30503,30983,31471,31967,32470,32981,33501,34028,34564,35109,35661,36223,36793,37373,37961,38559,39166,39783,40410,41046,41693,42349,43016,43693,44381,45080,45790,46511,47244,47988,48744,49511,50291,51083,51887,52704,53534,54377,55234,56104,56987,57885,58796,59722,60662,61618,62588,63574,64575,65592,66625,67674,68740,69822,70922,72039,73173,74325,75496,76685,77892,79119,80365,81630,82916,84222,85548,86895,88264,89654,91065,92499,93956,95436,96939,98465,100016,101591,103191,104816,106466,108143,109846,111576,113333,115118,116930,118772,120642,122542,124472,126432,128423,130445,132500,134586,136706,138858,141045,143266,145522,147814,150142,152506,154908,157347,159825,162342,164899,167495,170133,172812,175534,178298,181106,183958,186855,189797,192786,195822,198906,202038,205220,208451,211734,215068,218455,221895,225390,228939,232544,236207,239926,243705,247542,251441,255400,259422,263507,267657,271872,276153,280502,284920,289406,293964,298593,303295,308072,312923,317851,322856,327940,333105,338350,343679,349091,354588,360172,365844,371605,377457,383401,389439,395572,401801,408129,414556,421084,427715,434451,441292,448242,455300,462470,469753,477151,484665,492297,500050,507924,515923,524048,532300,540683,549197,557846,566631,575554,584617,593824,603175,612674,622322,632122,642077,652188,662458,672891,683487,694250,705183,716288,727568,739026,750664,762485,774492,786689,799077,811661,824443,837426,850614,864009,877615,891435,905473,919733,934216,948928,963872,979050,994468,1010129,1026036,1042194,1058606,1075276,1092210,1109409,1126880,1144626,1162651,1180960,1199558,1218448,1237636,1257126,1276923,1297031,1317456,1338203,1359277,1380682,1402425,1424510,1446943,1469729,1492874,1516383,1540263,1564518,1589156,1614181,1639601,1665421,1691648,1718287,1745346,1772832,1800750,1829107,1857912,1887169,1916888,1947075,1977737,2008881,2040517,2072650,2105290,2138443,2172119,2206325,2241069,2276361,2312208,2348620,2385606,2423174,2461333,2500093,2539464,2579455,2620075,2661336,2703246,2745815,2789056,2832977,2877590,2922905,2968934,3015688,3063179,3111417,3160414,3210184,3260737,3312086,3364244,3417223,3471036,3525697,3581219,3637615,3694899,3753085,3812187,3872221,3933199,3995138,4058052,4121957,4186869,4252802,4319774,4387801,4456899,4527085,4598376,4670790,4744344,4819057,4894946,4972030,5050328,5129859,5210643,5292698,5376046,5460707,5546700,5634048,5722771,5812892,5904432,5997413,6091858,6187791,6285235,6384213,6484750,6586870,6690598,6795959,6902980,7011686,7122104,7234261,7348184,7463901,7581440,7700831,7822101,7945281,8070401,8197492,8326583,8457708,8590898,8726185,8863602,9003183,9144963,9288975,9435255,9583839,9734762,9888063,10043777,10201943,10362601,10525788,10691545,10859912,11030931,11204643,11381090,11560316,11742365,11927280,12115108};

const static int32_t k_exp_yvals[1024] = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,10,10,10,10,10,10,11,11,11,11,11,12,12,12,12,12,13,13,13,13,13,14,14,14,14,15,15,15,15,15,16,16,16,17,17,17,17,18,18,18,18,19,19,19,20,20,20,21,21,21,22,22,22,23,23,23,24,24,25,25,25,26,26,27,27,28,28,28,29,29,30,30,31,31,32,32,33,33,34,34,35,35,36,37,37,38,38,39,40,40,41,42,42,43,44,44,45,46,46,47,48,49,49,50,51,52,53,54,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,75,76,77,78,79,81,82,83,85,86,87,89,90,91,93,94,96,97,99,100,102,104,105,107,109,110,112,114,116,118,119,121,123,125,127,129,131,133,135,137,140,142,144,146,149,151,153,156,158,161,163,166,169,171,174,177,179,182,185,188,191,194,197,200,203,207,210,213,217,220,223,227,231,234,238,242,245,249,253,257,261,265,270,274,278,283,287,292,296,301,306,310,315,320,325,331,336,341,346,352,357,363,369,375,380,386,393,399,405,411,418,425,431,438,445,452,459,466,474,481,489,496,504,512,520,528,537,545,554,563,571,580,590,599,608,618,628,638,648,658,668,679,689,700,711,722,734,745,757,769,781,794,806,819,832,845,858,872,885,899,913,928,942,957,972,988,1003,1019,1035,1051,1068,1085,1102,1119,1137,1155,1173,1192,1210,1229,1249,1268,1288,1309,1329,1350,1371,1393,1415,1437,1460,1483,1506,1530,1554,1579,1604,1629,1654,1680,1707,1734,1761,1789,1817,1846,1875,1904,1934,1965,1996,2027,2059,2092,2124,2158,2192,2226,2262,2297,2333,2370,2407,2445,2484,2523,2563,2603,2644,2686,2728,2771,2815,2859,2904,2950,2996,3043,3091,3140,3189,3240,3291,3343,3395,3449,3503,3558,3614,3671,3729,3788,3847,3908,3969,4032,4096,4160,4226,4292,4360,4428,4498,4569,4641,4714,4788,4864,4940,5018,5097,5177,5259,5342,5426,5511,5598,5686,5776,5867,5959,6053,6148,6245,6344,6443,6545,6648,6753,6859,6967,7077,7188,7301,7416,7533,7652,7772,7895,8019,8145,8274,8404,8536,8671,8807,8946,9087,9230,9375,9523,9673,9825,9980,10137,10297,10459,10624,10791,10961,11134,11309,11487,11668,11852,12038,12228,12420,12616,12815,13017,13222,13430,13641,13856,14074,14296,14521,14750,14982,15218,15458,15701,15948,16199,16455,16714,16977,17244,17516,17792,18072,18356,18646,18939,19237,19540,19848,20161,20478,20801,21128,21461,21799,22142,22491,22845,23205,23570,23942,24319,24702,25091,25486,25887,26295,26709,27129,27557,27991,28431,28879,29334,29796,30265,30742,31226,31718,32217,32724,33240,33763,34295,34835,35384,35941,36507,37082,37666,38259,38861,39473,40095,40726,41368,42019,42681,43353,44036,44729,45434,46149,46876,47614,48364,49125,49899,50685,51483,52294,53117,53954,54803,55666,56543,57433,58338,59257,60190,61138,62100,63078,64072,65081,66106,67147,68204,69278,70369,71477,72603,73746,74908,76087,77285,78502,79739,80994,82270,83565,84881,86218,87576,88955,90356,91779,93224,94692,96183,97698,99236,100799,102387,103999,105637,107300,108990,110706,112450,114221,116019,117846,119702,121587,123502,125447,127422,129429,131467,133537,135640,137776,139946,142150,144388,146662,148972,151318,153701,156121,158580,161077,163614,166190,168807,171466,174166,176909,179694,182524,185399,188318,191284,194296,197356,200464,203621,206827,210084,213393,216753,220166,223634,227155,230732,234366,238057,241806,245613,249481,253410,257401,261454,265571,269754,274002,278317,282699,287151,291673,296266,300932,305671,310485,315374,320340,325385,330509,335714,341001,346371,351825,357366,362993,368710,374516,380414,386404,392489,398670,404948,411325,417803,424382,431065,437854,444749,451753,458867,466093,473433,480888,488461,496153,503967,511903,519964,528152,536470,544918,553499,562215,571069,580062,589197,598475,607900,617473,627197,637074,647106,657296,667647,678161,688841,699688,710707,721899,733267,744815,756544,768457,780559,792851,805337,818019,830901,843985,857276,870776,884489,898418,912566,926937,941534,956361,971421,986719,1002258,1018041,1034073,1050357,1066898,1083699,1100765,1118099,1135707,1153592,1171758,1190211,1208954,1227992,1247330,1266973,1286924,1307191,1327776,1348685,1369924,1391497,1413410,1435668,1458277,1481241,1504567,1528261,1552327,1576773,1601603,1626825,1652444,1678466,1704898,1731746,1759017,1786718,1814855,1843434,1872464,1901951,1931903,1962326,1993228,2024617,2056500,2088885,2121780,2155193,2189133,2223606,2258623,2294191,2330320,2367017,2404292,2442154,2480612,2519676,2559355,2599659,2640598,2682181,2724420,2767323,2810902,2855167,2900130,2945800,2992190,3039310,3087172,3135788,3185169,3235328,3286277,3338029,3390595,3443989,3498224,3553313,3609270,3666107,3723840,3782482,3842048,3902551,3964007,4026431,4089839,4154244,4219664,4286114,4353610,4422170,4491809,4562545,4634394,4707375,4781506,4856804,4933287,5010975,5089886,5170040,5251457,5334155,5418156,5503479,5590147,5678179,5767597,5858423,5950680,6044390,6139575,6236259,6334466,6434219,6535544,6638463,6743004,6849191,6957050,7066608,7177891,7290926,7405741,7522365,7640825,7761150,7883371,8007516,8133616,8261701,8391804,8523956,8658189,8794535,8933029,9073704,9216594,9361734,9509160,9658908,9811013,9965514,10122448,10281854,10443769,10608235,10775290,10944976,11117335,11292407,11470237,11650867,11834341,12020705};


#define tinymath_abs_int32(x) ((x) > 0 ? (x): (-x))

void tinytensor_descale(Weight_t * y, int8_t * out_scale, int32_t x, int8_t in_scale) {
    //make it fit in 8 bits
    uint8_t i;
    int32_t ux = tinymath_abs_int32(x);
    
    for (i = 0; i < 24; i++) {
        if (  (ux >> i) <= 127 ) {
            break;
        }
    }
    
    *out_scale = in_scale - i;
    *y = x >> i;
    
}

void tinytensor_tanh(Weight_t * y, int8_t * out_scale, int32_t x,int8_t in_scale) {
    const static uint32_t k_max_len = sizeof(k_tanh_yvals) / sizeof(k_tanh_yvals[0]);
    const uint8_t sign = x < 0;
    int32_t yy;
    const int8_t shift = 15 - QFIXEDPOINT;
    
    *out_scale = 0;
    int32_t i;
    int16_t dx;
    
    x = tinymath_abs_int32(x);
    
    if (in_scale > 0) {
        x >>= in_scale;
    }
    
    if (in_scale < 0) {
        x <<= -in_scale;
    }
    
    x <<= shift;
    
    //in Q15, 4.0 is 2^2 * 2^15 = 2^17
    //however we have a 10 bit interval, so right shift by 7
    i = x >> 7;
    
    assert(i >= 0);
    
    if (i > k_max_len) {
        yy = MAX_WEIGHT;
    }

    else {
        dx = x - (i << 7);
        assert(dx >= 0);
        yy = k_tanh_yvals[i] + MUL16(dx, k_tanh_slopes[i]);
    }

    if (sign) {
        yy = -yy;
    }
    yy >>= shift; //go back from Q15

    *y = yy;
}

//(tanh + 1) / 2 == sigmoid
//crud, but should work okay
void tinytensor_sigmoid(Weight_t * y, int8_t * out_scale, int32_t x,int8_t in_scale) {
    Weight_t tanh;
    int16_t temp16;
    
    tinytensor_tanh(&tanh,out_scale,x,in_scale);
    temp16 = tanh;
    
    //add one
    temp16 += (1 << QFIXEDPOINT);
    
    //divide by two
    temp16 >>= 1;
    
    if (temp16 > MAX_WEIGHT) {
        temp16 = MAX_WEIGHT;
    }
    
    *y = (Weight_t)temp16;
    *out_scale = 0;
}


int32_t tinytensor_exp_q12(Weight_t x) {
    int32_t temp32 = 0;
    int16_t idx = x >> 6;
    int16_t dx = x - (idx << 6);
    idx += 512;
    
    assert(idx >= 0 && idx <= 1024);
    
    {
        int64_t temp64;
        const int32_t slope = k_exp_slopes[idx];
        const int32_t yval = k_exp_yvals[idx];
        
        temp64 = (int64_t)dx * slope;
        temp64 >>= QFIXEDPOINT;
        temp64 += yval;
        
        if (temp64 > INT32_MAX) {
            temp64 = INT32_MAX;
        }
        
        if (temp64 < INT32_MIN) {
            temp64 = INT32_MIN;
        }
        
        temp32 = (int64_t) temp64;
        
    }
    
    return temp32;
}

void tinytensor_vec_softmax_in_place(Weight_t * xvec, uint32_t len, int8_t in_scale) {
    uint32_t i;
    int64_t temp64;
    int32_t val;
    int64_t expval;
    temp64 = 0;

    for (i = 0; i < len; i++) {
        val = xvec[i];
        
        if (in_scale > 0) {
            val >>= in_scale;
        }
        
        if (in_scale < 0) {
            val <<= -in_scale;
        }
        
        if (val > INT16_MAX) {
            val = INT16_MAX;
        }
        
        if (val < INT16_MIN) {
            val = INT16_MIN;
        }
        temp64 += tinytensor_exp_q12(val);
    }
    
    for (i = 0; i < len; i++) {
        val = xvec[i];
        
        if (in_scale > 0) {
            val >>= in_scale;
        }
        
        if (in_scale < 0) {
            val <<= -in_scale;
        }
        
        if (val > INT16_MAX) {
            val = INT16_MAX;
        }
        
        if (val < INT16_MIN) {
            val = INT16_MIN;
        }
    
        expval = tinytensor_exp_q12(val);

        val = (expval << QFIXEDPOINT) / temp64;
    
    
        if (val > MAX_WEIGHT) {
            val = MAX_WEIGHT;
        }
        
        if (val < -MAX_WEIGHT) {
            val = -MAX_WEIGHT;
        }
        
        xvec[i] = val;
        
    }
    
}


void tinytensor_linear(Weight_t * y, int8_t * out_scale, int32_t x,int8_t in_scale) {
    
    if (x > MAX_WEIGHT) {
        x = MAX_WEIGHT;
    }
    
    if (x < -MAX_WEIGHT) {
        x = -MAX_WEIGHT;
    }
    
    *y = x;
    *out_scale = in_scale;
}


void tinytensor_relu(Weight_t * y, int8_t * out_scale, int32_t x,int8_t in_scale) {
    x =  x < 0 ? 0 : x;
    
    if (x > MAX_WEIGHT) {
        x = MAX_WEIGHT;
    }
    
    *y = x;
    *out_scale = in_scale;

}




int8_t tiny_tensor_get_scaling(int32_t x) {
    int8_t i;
    
    if (x == 0) {
        return 0;
    }

    //find max scaling
    x = tinymath_abs_int32(x);
    
    for (i = 0; i < 8; i++) {
        if (( ((int16_t)x) << i) > MAX_WEIGHT/2) {
            break;
        }
    }
    
    return i;
    
}

inline int8_t tiny_tensor_get_descaling(int32_t x) {
    int8_t i;

    x = tinymath_abs_int32(x);
    
    for (i = 0; i < 31; i++) {
        if ((x >> i) <= MAX_WEIGHT) {
            break;
        }
    }
    
    return i;
    
}

int8_t tiny_tensor_compare_scaled_numbers(const Weight_t x1, const int8_t scale1, const Weight_t x2, const int8_t scale2) {
    int32_t xx1 = x1 << 16;
    int32_t xx2 = x2 << 16;
    
    xx1 = tinymath_abs_int32(xx1);
    xx2 = tinymath_abs_int32(xx2);
    
    if (scale1 > 0) {
        xx1 >>= scale1;
    }
    else {
        xx1 <<= -scale1;
    }
    
    if (scale2 > 0) {
        xx2 >>= scale2;
    }
    else {
        xx2 <<= -scale2;
    }
  
    
    if (xx1 > xx2) {
        return 1;
    }
    
    if (xx2 > xx1) {
        return -1;
    }
    
    return 0;
    
}



